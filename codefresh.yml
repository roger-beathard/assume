version: '1.0'
steps:
  compile_binary:
    image: r.cfcr.io/s3than/golang:latest
    working_directory: ${{main_clone}}
    description: Building App
    commands:
    - |
      mkdir -p /go/src/github.com/${{CF_REPO_OWNER}}
      ln -s /codefresh/volume/${{CF_REPO_NAME}} /go/src/github.com/${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
      cd /go/src/github.com/${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
      # Install pre-requisites and execute tests
      dep ensure
      GOOS=linux GOARCH=amd64 go build -v -o pkg/assume_${{CF_BRANCH_VERSION_NORMALIZED}}_linux_amd64
      if []
      cd pkg
      zip assume_${{CF_BRANCH_VERSION_NORMALIZED}}_linux_amd64.zip assume_${{CF_BRANCH_VERSION_NORMALIZED}}_linux_amd64
      ghr --delete -t ${{GITHUB_TOKEN}} -b "${{CF_COMMIT_MESSAGE}}" -u ${{CF_REPO_OWNER}} -r ${{CF_REPO_NAME}} ${{CF_BRANCH}} assume_${{CF_BRANCH_VERSION_NORMALIZED}}_linux_amd64.zip
    when:
      condition:
        all:
          tag: '"${{CF_BRANCH}}" == "^(?:([v]\d+)\.)?(?:(\d+)\.)?(\*|\d+)$"'